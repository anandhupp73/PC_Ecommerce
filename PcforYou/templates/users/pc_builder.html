{% extends "index.html" %}
{% block title %}PC Builder{% endblock %}
{% block content %}

<style>
    /* ---------------------------------
       1. COLOR PALETTE
    -----------------------------------*/
    :root {
        --color-bg-dark: #0A111F;      /* Main Background */
        --color-card-bg: #1A2233;      /* Card Background */
        --color-comp-bg: #2C3545;      /* Modal Item/Compatibility Box BG */
        --color-accent: #6C5CE7;       /* Primary Purple Accent */
        --color-accent-hover: #5D4AD8; /* Darker Hover */
        --color-text-light: #E0E7FF;   /* Main Text Color */
        --color-text-subtle: #9BA4B5;  /* Sub-text/Preview */
        --color-success: #34D399;      /* Green Check */
        --color-error: #F87171;        /* Red Error */
        --color-warning: #FBBF24;      /* Yellow Warning */
    }

    body {
        background-color: var(--color-bg-dark);
    }

    /* ---------------------------------
       2. LAYOUT & TYPOGRAPHY
    -----------------------------------*/
    .builder-title {
        text-align: center;
        font-size: 40px;
        margin-bottom: 40px;
        color: var(--color-text-light);
        font-weight: 700;
        letter-spacing: 2px;
        text-shadow: 0 0 10px rgba(108, 92, 231, 0.4); /* Subtle glow */
    }

    .builder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        padding: 5px 20px;
    }

    .component-card {
        background: var(--color-card-bg);
        padding: 25px;
        border-radius: 16px;
        /* Premium shadow effect */
        box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
        color: var(--color-text-light);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .component-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.7), 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    .component-card h3 {
        font-size: 20px;
        margin-bottom: 15px;
        color: var(--color-accent);
    }

    .preview-area {
        height: 180px; /* Fixed height for consistency */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .preview-area img {
        max-width: 90%;
        max-height: 120px;
        border-radius: 8px;
        object-fit: contain; /* Prevents stretching */
    }
    
    .preview-area p {
        color: var(--color-text-subtle);
        font-style: italic;
        margin-top: 10px;
        font-size: 14px;
        line-height: 1.2;
    }


    /* ---------------------------------
       3. BUTTONS
    -----------------------------------*/
    .select-btn {
        width: 100%;
        padding: 12px;
        /* Vibrant Gradient */
        background: linear-gradient(90deg, #8A6FFB 0%, var(--color-accent) 100%);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        border: none;
        margin-top: 10px;
        transition: 0.3s;
        box-shadow: 0 4px 10px rgba(108, 92, 231, 0.4);
    }
    .select-btn:hover {
        background: linear-gradient(90deg, #7A5EFB 0%, var(--color-accent-hover) 100%);
        box-shadow: 0 6px 15px rgba(108, 92, 231, 0.6);
        transform: scale(1.02);
    }
    
    /* Ask Gemini Button */
    .gemini-btn {
        margin: 30px 0 20px 20px;
        padding: 12px 25px;
        background: linear-gradient(135deg, #0A78F0 0%, #15C6E9 100%);
        color: white;
        font-size: 17px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 5px 15px rgba(21, 198, 233, 0.4);
    }
    .gemini-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    /* ---------------------------------
       4. COMPATIBILITY BOX
    -----------------------------------*/
    .compat-box {
        margin-top: 40px;
        /* Subtle Gradient Background */
        background: linear-gradient(90deg, #1f2937, #1f2937, #2c3545);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 25px;
        border-radius: 14px;
        margin: 0 10px;
        color: var(--color-text-light);
        font-size: 17px;
        line-height: 1.8;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    /* Compatibility Status Styling */
    .compat-box span {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
    .compat-box .success { color: var(--color-success); }
    .compat-box .error { color: var(--color-error); }
    .compat-box .warning { color: var(--color-warning); }


    /* ---------------------------------
       5. MODAL STYLES
    -----------------------------------*/
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); /* Darker overlay */
        z-index: 999;
        overflow-y: auto;
    }

    .modal-content {
        background: var(--color-card-bg); /* Slightly lighter modal background */
        width: 85%;
        max-width: 1000px;
        margin: 5vh auto;
        padding: 30px;
        border-radius: 16px;
        color: var(--color-text-light);
        box-shadow: 0 10px 40px rgba(0,0,0,0.7);
        max-height: 90vh; /* Allow modal to take most of the screen */
        overflow-y: auto;
    }
    
    .modal-content h2 {
        color: var(--color-accent);
        margin-bottom: 20px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 10px;
    }

    .close {
        font-size: 36px;
        cursor: pointer;
        float: right;
        line-height: 1;
        color: var(--color-text-subtle);
        transition: color 0.2s;
    }
    .close:hover {
        color: var(--color-error);
    }

    .modal-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 25px;
        margin-top: 20px;
    }

    .modal-item {
        background: var(--color-comp-bg);
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        border: 1px solid transparent;
    }

    .modal-item img {
        width: 100%;
        height: 120px;
        object-fit: contain;
        border-radius: 8px;
        background-color: #0A111F; /* Component image background */
    }
    
    .modal-item h4 {
        margin-top: 10px;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.3;
    }

    .modal-item:hover {
        background: #374151;
        border: 1px solid var(--color-accent);
        box-shadow: 0 0 10px rgba(108, 92, 231, 0.4);
    }
    
    /* Gemini Modal Specifics */
    #geminiModal .modal-content {
        max-width: 800px;
    }
    #geminiResult {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 16px;
        line-height: 1.7;
        color: #C0CCDD;
    }

</style>

<h1 class="builder-title">Ultimate PC Builder</h1>

<div class="builder-grid">

    {% for part in parts %}
    <div class="component-card">
        <h3>{{ part }}</h3>

        <div id="{{ part|lower }}-preview" class="preview-area">
            <p>No {{ part }} selected</p>
        </div>

        <button class="select-btn" onclick="openModal('{{ part }}')">
            Select {{ part }}
        </button>
    </div>
    {% endfor %}

</div>

{% comment %} <div id="compatibility" class="compat-box">
    Your build compatibility results will appear here. Select at least a CPU and Motherboard.
</div> {% endcomment %}

<div id="componentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Select Component</h2>

        <div id="modalItems" class="modal-items"></div>
    </div>
</div>

<div id="geminiModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeGeminiModal()">&times;</span>
        <h2><span style="color: #15C6E9;">AI</span> Compatibility Analysis</h2>
        <div id="geminiResult" style="margin-top: 20px;">
            <p>Waiting for the analysis...</p>
        </div>
        <button onclick="downloadPDF()" class="gemini-pdf-btn">ğŸ“„ Download PDF</button>
    </div>
    
</div>

<button onclick="getGeminiResult()" class="gemini-btn">
    ğŸ” Ask Gemini AI for Detailed Check
</button>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>

/* ---------------------------------
   LOAD PRODUCT DATA FROM DJANGO 
----------------------------------*/
const componentData = {
    cpu: [
        {% for p in cpus %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            socket: "{{ p.cpu_details.socket_type }}",
            tdp: "{{ p.cpu_details.tdp }}",
            selected: false
        },
        {% endfor %}
    ],
    motherboard: [
        {% for p in motherboards %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            socket: "{{ p.motherboard_details.socket_type }}",
            ram_type: "{{ p.motherboard_details.ram_type }}",
            form: "{{ p.motherboard_details.form_factor }}",
            selected: false
        },
        {% endfor %}
    ],
    ram: [
        {% for p in rams %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            ddr: "{{ p.ram_details.ddr_type }}",
            selected: false
        },
        {% endfor %}
    ],
    gpu: [
        {% for p in gpus %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            power: "{{ p.gpu_details.power_draw }}",
            selected: false
        },
        {% endfor %}
    ],
    storage: [
        {% for p in storages %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            type: "{{ p.storage_details.storage_type }}",
            selected: false
        },
        {% endfor %}
    ],
    cooling: [
        {% for p in coolings %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            type: "{{ p.cooling_details.cooling_type }}",
            selected: false
        },
        {% endfor %}
    ],
    psu: [
        {% for p in psus %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            watt: "{{ p.powersupply_details.wattage }}",
            selected: false
        },
        {% endfor %}
    ],
    case: [
        {% for p in cases %}
        {
            id: "{{ p.id }}",
            name: "{{ p.name }}",
            img: "{{ p.image.url }}",
            form: "{{ p.cabinet_details.form_factor }}",
            selected: false
        },
        {% endfor %}
    ]
};

let currentPart = null;

/* ------------------------------
   OPEN MODAL
-------------------------------*/

function openModal(part) {
    currentPart = part.toLowerCase();
    document.getElementById("modalTitle").innerText = `Select ${part}`;

    const modalArea = document.getElementById("modalItems");
    modalArea.innerHTML = "";

    componentData[currentPart].forEach(item => {
        // Fallback specs display for the modal list
        let modalSpecs = item.specs || item.socket || item.ddr || item.power || item.type_detail || item.watt || item.form;
        modalArea.innerHTML += `
            <div class="modal-item" onclick="selectComponent('${currentPart}', '${item.id}')">
                <img src="${item.img}" alt="${item.name}" style="max-width: 90%; max-height: 80px; object-fit: contain;">
                <h4>${item.name}</h4>
                <p style="font-size: 11px; color: var(--color-text-subtle); margin-top: 5px;">${modalSpecs}</p>
            </div>
        `;
    });

    document.getElementById("componentModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("componentModal").style.display = "none";
}


/* ------------------------------
   HANDLE SELECT COMPONENT
-------------------------------*/
function selectComponent(part, id) {
    componentData[part].forEach(i => i.selected = false);
    const item = componentData[part].find(i => i.id === id);
    item.selected = true;

    document.getElementById(part + "-preview").innerHTML = `
        <img src="${item.img}">
        <p>${item.name}</p>
    `;

    closeModal();
    runCompatibility();
}

function getSelectedData(partKey) {
    const items = componentData[partKey];
    if (!items) return null;

    const selected = items.find(i => i.selected === true);
    return selected ? selected : null;
}

function collectSelectedParts() {
    const parts = {
        cpu: getSelectedData("cpu"),
        motherboard: getSelectedData("motherboard"),
        ram: getSelectedData("ram"),
        gpu: getSelectedData("gpu"),
        storage: getSelectedData("storage"),
        cooling: getSelectedData("cooling"),
        psu: getSelectedData("psu"),
        case: getSelectedData("case")
    };

    // Remove null items
    const filtered = {};
    for (const [key, value] of Object.entries(parts)) {
        if (value !== null) filtered[key] = value;
    }
    return filtered;
}



async function getGeminiResult() {
Â  Â  const selectedParts = collectSelectedParts();

    // Safety: ensure at least ANY two components selected
    const selectedCount = Object.values(selectedParts).filter(p => p !== null).length;

    if (selectedCount < 2) {
        alert("Please select at least TWO components before running the AI compatibility check!");
        return;
    }


Â  Â  // Re-inserting the full prompt content and adding instructions 
    // for robust, structured output to prevent empty responses.
    const prompt = `
    You are a professional PC compatibility engine.

    You will receive a JSON object containing ONLY the components selected by the user. 
    If a component is NOT present in the JSON, you MUST NOT mention it, MUST NOT describe it, and MUST NOT give recommendations for it.

    â— VERY IMPORTANT RULE:
    Only analyze components that exist in the JSON. If CPU is missing, do not talk about CPU. If RAM is missing, do not talk about RAM. If Case is missing, do not talk about cases. DO NOT mention missing components AT ALL.

    Provide a structured, clean Markdown report analyzing ONLY the provided parts.

    Required sections:
    - Component Overview (ONLY list provided parts)
    - Compatibility Checks (ONLY between provided parts)
    - Performance / Power / Form Factor observations (ONLY if relevant to the parts given)
    - Final Verdict (0â€“10) based on ONLY the provided components

    Here is the provided parts list:
    ${JSON.stringify(selectedParts, null, 2)}
    `;

Â  Â  // Set initial loading message
Â  Â  document.getElementById("geminiResult").innerHTML = '<p style="color:#15C6E9;">Loading analysis from Gemini AI...</p>';
Â  Â  openGeminiModal(); // Open modal immediately with loading message

Â  Â  try {
Â  Â  Â  Â  const response = await fetch("/api/gemini-compat-check/", {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  "Content-Type": "application/json",
Â  Â  Â  Â  Â  Â  Â  Â  "X-CSRFToken": getCookie("csrftoken"),
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ prompt }),
Â  Â  Â  Â  });

Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  // ğŸ’¡ CRITICAL CHANGE: Handle non-200 responses (like 400 or 500)
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  // Display the error message returned from the Django view
Â  Â  Â  Â  Â  Â  document.getElementById("geminiResult").innerHTML = 
Â  Â  Â  Â  Â  Â  Â  Â  `<p style="color:var(--color-error);">âš ï¸ Server Error:</p><p>${data.error || 'Unknown error occurred.'}</p>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // SUCCESS PATH (HTTP 200)
Â  Â  Â  Â  document.getElementById("geminiResult").innerHTML =
            marked.parse(data.response); 

Â  Â  } catch (error) {
Â  Â  Â  Â  // NETWORK ERROR PATH (e.g., server offline, CORS issue)
Â  Â  Â  Â  document.getElementById("geminiResult").innerHTML =
Â  Â  Â  Â  Â  Â  '<p style="color:var(--color-error);">Fatal Network Error: Could not connect to the server.</p>';
Â  Â  }
}

/* ------------------------------
   GEMINI MODAL
-------------------------------*/
function openGeminiModal() {
    document.getElementById("geminiModal").style.display = "flex";
}

function closeGeminiModal() {
    document.getElementById("geminiModal").style.display = "none";
}

/* ------------------------------
   CSRF
-------------------------------*/
function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(";").forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
            cookieValue = cookie.substring(name.length + 1);
        }
    });
    return cookieValue;
}

{% comment %} ---------------------------pdfreport---------------- {% endcomment %}

async function downloadPDF() {

    const selectedParts = collectSelectedParts();
    const reportHtml = document.getElementById("geminiResult").innerHTML;

    const response = await fetch("/generate-pdf/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
            selected_parts: selectedParts,
            ai_report: reportHtml
        }),
    });

    if (!response.ok) {
        alert("Error generating PDF");
        return;
    }

    // Convert response to file
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "PC_Compatibility_Report.pdf";
    a.click();
    URL.revokeObjectURL(url);
}


</script>

{% endblock %}