{% extends "admin/admin_dashboard.html" %} 
{% load tz %}


{% block title %}Admin Order Management{% endblock %}


{% block content %}
<div class="order-table-card">
    <h2 style="margin-bottom: 15px; font-size: 20px; font-weight: 700;">Order Management</h2>

    <div class="table-wrapper">
    <table class="orders-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Date</th>
                <th>Status</th>
                <th style="text-align: right;">Actions</th>
            </tr>
        </thead>

        <tbody>
            {% for order in orders %}
            <tr>
                <td><span class="order-id">#{{ order.id }}</span></td>

                {% comment %} <td><span class="customer-name">{{ order.user }}</span></td> {% endcomment %}

                <td>
                    <div class="customer-name">
                        {% comment %} <strong>{{ order.user.profile.display_name|default:order.user.username }}</strong> {% endcomment %}
                    </div>

                    <div style="font-size: 13px; color: #9ca3af; margin-top: 4px;">
                        {{ order.address|linebreaksbr }}
                    </div>

                    <div style="margin-top: 6px; font-size: 13px;">
                        <strong>Products:</strong>
                        <ul style="margin: 4px 0 0 16px; padding: 0;">
                            {% for item in order.items.all %}
                                <li>
                                    {% if item.product %}
                                        {{ item.product.name }}
                                    {% elif item.prebuilt_pc %}
                                        {{ item.prebuilt_pc.name }}
                                    {% endif %}
                                    Ã— {{ item.quantity }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </td>

                <td><span class="order-total">${{ order.total_amount }}</span></td>

                {% localtime on %}
                <td><span class="order-date">{{ order.created_at|date:"Y-m-d H:i" }}</span></td>
                {% endlocaltime %}

                <td>
                    <span class="status-badge status-{{ order.status }}">
                        {{ order.get_status_display }}
                    </span>
                </td>

                <td style="text-align: right;">
                    {% if order.status != 'DELIVERED' and order.status != 'CANCELLED' %}

                        {% if order.status == 'PENDING' %}
                            <button class="btn-indigo" onclick="updateStatus({{ order.id }}, 'CONFIRMED')">Confirm</button>
                            <button class="btn-red" onclick="updateStatus({{ order.id }}, 'CANCELLED')">Cancel</button>

                        {% elif order.status == 'CONFIRMED' %}
                            <button class="btn-indigo" onclick="updateStatus({{ order.id }}, 'SHIPPED')">Ship</button>
                            <button class="btn-red" onclick="updateStatus({{ order.id }}, 'CANCELLED')">Cancel</button>

                        {% elif order.status == 'SHIPPED' %}
                            <button class="btn-indigo" onclick="updateStatus({{ order.id }}, 'OUT_FOR_DELIVERY')">Out for delivery</button>
                            <button class="btn-red" onclick="updateStatus({{ order.id }}, 'CANCELLED')">Cancel</button>

                        {% elif order.status == 'OUT_FOR_DELIVERY' %}
                            <button class="btn-green" onclick="updateStatus({{ order.id }}, 'DELIVERED')">Deliver</button>
                            <button class="btn-red" onclick="updateStatus({{ order.id }}, 'CANCELLED')">Cancel</button>
                        {% endif %}

                    {% else %}
                        <span class="finalized">Finalized</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>

    </table>
    </div>
</div>


    <script>
    function updateStatus(orderId, newStatus) {
        if (!confirm(`Are you sure you want to change Order #${orderId} to ${newStatus}?`)) return;

        fetch("{% url 'update_order_status' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: `order_id=${orderId}&new_status=${newStatus}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to reflect updated status
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => alert('Error: ' + error));
    }
    </script>

{% endblock %}